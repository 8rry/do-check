# 返礼品情報整形GAS 詳細仕様書

## 1. システム概要

### 1.1 目的
事業者から集めた返礼品情報を、マスタ登録用に整形するGASシステム

### 1.2 対象データ
- 返礼品シート（Excelファイル .xlsx）
- 自治体フォルダ内の事業者フォルダ
- 指定されたセル範囲のデータ

## 2. スプレッドシート構成

### 2.1 基本情報
- **スプレッドシートID**: `1W-Kmre4FTL5iU0VNSs5Z4vLVsXzFebLYlxSxnPWkxPQ`
- **URL**: https://docs.google.com/spreadsheets/d/1W-Kmre4FTL5iU0VNSs5Z4vLVsXzFebLYlxSxnPWkxPQ/edit?gid=0#gid=0

### 2.2 タブ構成

#### **情報抽出タブ**
- **B1**: 返礼品シートのフォルダパス（必須）
  - 例: `G:\共有ドライブ\h_40348_福岡県_久山町_01\h_久山町\03_共通\99_資料\02_返礼品関係\k_株式会社亀井通産\2025-06-16_返礼品登録シート_亀井通産株式会社(一品香食品うどん定期便).xlsx`
- **B2**: 抽出するセル情報（オプション）
  - 例: `F,H,J,L,N,P`
  - 空の場合はF列起点で全データを取得
- **A7**: Do書き出し項目
- **B7**: 大項目
- **C7**: 小項目
- **D7以降**: チェックボックス（7行目）とデータ内容（8行目）

#### **Do書き出し用タブ**
- **1行目**: 項目名（A列から順番）
  - 商品ID, 発送種別, 商品コード, 配達会社用商品コード, 商品名称, 配送伝票商品名称, 定期便フラグ, 定期便回数, 定期便種別, 配送スパン, コラボフラグ, 寄附金額1, 寄附金額(開始)1, 寄附金額(終了)1, 寄附金額2, 寄附金額(開始)2, 寄附金額(終了)2, 寄附金額3, 寄附金額(開始)3, 寄附金額(終了)3, 出品ステータス, 見出し, 内容量１, 原産地種別１(削除予定), 原産地１(削除予定), 内容量２(削除予定), 原産地種別２(削除予定), 原産地２(削除予定), 内容量３(削除予定), 原産地種別３(削除予定), 原産地３(削除予定), 内容量４(削除予定), 原産地種別４(削除予定), 原産地４(削除予定), 内容量５(削除予定), 原産地種別５(削除予定), 原産地５(削除予定), 商品詳細, 賞味期限, 原材料, 注意事項, 生産者の声, 税率種別, お礼の品不要, 商品マスタ削除フラグ, 定期便/コラボ商品コード1, 定期便/コラボ商品コード2, 定期便/コラボ商品コード3, 定期便/コラボ商品コード4, 定期便/コラボ商品コード5, 定期便/コラボ商品コード6, 定期便/コラボ商品コード7, 定期便/コラボ商品コード8, 定期便/コラボ商品コード9, 定期便/コラボ商品コード10, 定期便/コラボ商品コード11, 定期便/コラボ商品コード12, 出品商品マスタID, 集荷先名, 出荷重量種別, 出荷時サイズ, 在庫数, 1日の出荷数上限, 通常便出荷リードタイム(日), 通常便出荷リードタイム翌月指定日, 定期便出荷リードタイム(日), 定期便出荷リードタイム翌月指定日, アラート在庫数, 出荷可能日フラグ(月), 出荷可能日フラグ(火), 出荷可能日フラグ(水), 出荷可能日フラグ(木), 出荷可能日フラグ(金), 出荷可能日フラグ(土), 出荷可能日フラグ(日), 出荷可能日フラグ(祝日), 受付期間種別, 受付期間(開始), 受付期間(終了), 発送期間種別, 発送期間(開始), 発送期間(終了), 提供価格(税込)1, 提供価格(開始)1, 提供価格(税込)2, 提供価格(開始)2, 提供価格(税込)3, 提供価格(開始)3, 配送会社, 同梱先発送日数, 重量, 個口数, 個口作成種別, 固定送料1, 固定送料(開始)1, 固定送料(終了)1, 固定送料2, 固定送料(開始)2, 固定送料(終了)2, 固定送料3, 固定送料(開始)3, 固定送料(終了)3, 出品商品情報削除フラグ, 地場産品基準類型, 地場産品類型選択理由

#### **Do書き出し用(定期)タブ**
- Do書き出し用タブと同様の構成

#### **自治体フォルダタブ**
- **A列**: no（連番）
- **B列**: フォルダ名
- **C列**: フォルダID（Google DriveのフォルダID）
- **データ開始行**: 2行目

## 3. 処理フロー

### 3.1 Phase 1: 基本データ抽出（実装完了）
1. **情報抽出タブのB1からファイルパスを読み込み**
2. **ファイルパスから自治体フォルダキーを抽出**
   - 例: `G:\共有ドライブ\h_40348_福岡県_久山町_01\...` → キー: `h_40348_福岡県_久山町_01`
3. **自治体フォルダタブでキーに一致する行を検索**
   - B列でキーを検索し、対応するC列のフォルダIDを取得
4. **取得したフォルダIDでGoogle Driveフォルダにアクセス**
5. **指定されたファイル名のExcelファイルを検索・開く**
6. **A列〜D列を参照し、「商品名」列を特定**
7. **発見した列とその右隣列の4行目以降のデータを抽出**
8. **空行が5行連続したら抽出を終了**
9. **情報抽出タブのB8、C8以降に順次格納**

### 3.2 Phase 2: 指定列データ抽出（実装完了）

#### **B2セルに指定がある場合**
- **形式**: カンマ区切りの列指定（例: `F,H,J,L,N,P`）
- **処理**: 指定された列のみを抽出
- **出力**: 1列1返礼品の形式（縦方向）

#### **B2セルが空の場合**
- **処理**: F列を起点に返礼品データを抽出
- **結合セル対応**: 必要（F列以降の結合セルに対応）
- **出力**: 1列1返礼品の形式（縦方向）

### 3.3 データ抽出オプション
- **B2が空の場合**: F列起点で全データを抽出
- **B2に値がある場合**: 指定されたセルのみ抽出

### 3.4 マッピング処理
- 情報抽出タブのA7以降の項目とDo書き出し項目を照合
- チェックボックスが選択された項目のみ処理
- 大項目・小項目による分類管理

## 4. 技術要件

### 4.1 対応ファイル形式
- Excelファイル (.xlsx)
- Google Drive上のファイル

### 4.2 処理制限
- Google Apps Scriptの実行時間制限（6分）
- ファイルサイズ制限
- メモリ使用量制限

### 4.3 エラーハンドリング
- ファイル読み込みエラー
- データ抽出エラー
- マッピングエラー
- 出力エラー

## 5. 出力形式

### 5.1 情報抽出タブ（Phase 1出力）
- **B8**: 発見した列の4行目の値
- **C8**: 右隣列の4行目の値
- **B9**: 発見した列の5行目の値
- **C9**: 右隣列の5行目の値
- 以下同様に続く（空行が5行連続するまで）

### 5.2 情報抽出タブ（Phase 2出力）

#### **4行目-6行目（1行目-3行目のデータ）**
- **D4**: 1行目の1列目データ
- **E4**: 1行目の2列目データ
- **F4**: 1行目の3列目データ
- **D5**: 2行目の1列目データ
- **E5**: 2行目の2列目データ
- **F5**: 2行目の3列目データ
- **D6**: 3行目の1列目データ
- **E6**: 3行目の2列目データ
- **F6**: 3行目の3列目データ

#### **8行目以降（4行目以降のデータ）**
- **D8**: 4行目の1列目データ
- **E8**: 5行目の1列目データ
- **F8**: 6行目の1列目データ
- **D9**: 7行目の1列目データ
- **E9**: 8行目の1列目データ
- **F9**: 9行目の1列目データ
- 以下同様に続く（**1列1返礼品**の形式）

### 5.3 Do書き出し用タブ
- 1行目: ヘッダー（項目名）
- 2行目以降: 抽出・整形されたデータ

### 5.4 ログ出力
- 処理状況のログ
- エラー情報の記録
- 処理結果のサマリー

## 6. 実装フェーズ

### Phase 1: 基本データ抽出（実装完了）
- [x] ファイルパスからの自治体フォルダキー抽出
- [x] 自治体フォルダタブからのフォルダID取得
- [x] Google Driveフォルダアクセス
- [x] Excelファイル検索・開封
- [x] 商品名列特定（A列〜D列対応）
- [x] データ抽出・情報抽出タブへの格納
- [x] 空行連続による終了判定
- [x] 動的な列位置対応

### Phase 2: 指定列データ抽出（実装完了）
- [x] 指定列の選択的抽出
- [x] F列起点の返礼品データ抽出
- [x] 結合セル対応
- [x] 1列1返礼品の出力形式
- [x] セル結合による行数調整

### Phase 3: Do書き出し項目との紐付け（実装完了）
- [x] Do項目との自動マッチング
- [x] キーワードベースの検索
- [x] AND検索・OR検索の対応
- [x] スコアベースの最適マッチング
- [x] 新・旧項目の優先順位制御

### Phase 4: Doへの書き出し（次期実装予定）
- [ ] チェックボックス確認による選択的処理
- [ ] 単一商品・定期便の自動判別
- [ ] Do書き出し用タブへのデータ出力
- [ ] 定期便対応（子マスタ・親マスタ生成）
- [ ] データクレンジング処理
- [ ] エラー処理強化

#### **4.1 処理フロー概要**
1. **チェックボックス確認**: D列以降の7行目のチェック状態を確認
2. **商品種別判別**: 単一商品か定期便かの自動判別
3. **データ抽出・格納**: 項目名をキーとしたDo書き出し用データの格納
4. **データクレンジング**: 各種データの整形・変換処理

#### **4.2 詳細処理フロー**

##### **4.2.1 チェックボックス確認**
- **対象**: D列以降の7行目
- **処理**: チェックがついている列のみを作業対象とする
- **出力**: 作業対象列のリスト

##### **4.2.2 商品種別判別**
- **判定基準**: A列の「商品名称」行の値に「定期」文字が含まれるか
- **結果**:
  - 「定期」を含む → 定期便
  - 「定期」を含まない → 単一商品

##### **4.2.3 データ抽出・格納**
- **処理対象**: チェックされている列の8行目以降
- **キー**: A8:A200で設定されている項目名
- **出力先**:
  - 単一商品: 「Do書き出し用」タブ
  - 定期便: 「Do書き出し用(定期)」タブ
- **格納ルール**: データの最終行に追加（上書き防止）

##### **4.2.4 定期便特別処理**
- **子マスタ生成**: 1回目→2回目→3回目の順序で生成
- **親マスタ生成**: 子マスタ生成後に生成
- **商品コード変換**:
  - 子マスタ: 元コード + "-" + 回数（例: ABC123-1）
  - 親マスタ: 元コードそのまま
- **商品名称変換**:
  - 定期便表記を除去
  - 通常商品名: 【】形式
  - 伝票記載用商品名: ()形式
- **親マスタ専用項目**:
  - 定期便フラグ: "有"
  - 定期便回数: 数値（例: "3"）
  - 背景色: 薄い青色（#E6F3FF）で段ズレ防止
- **定期便種別**: I列に以下を反映
  - ◯回定期便：月ごとに商品指定
  - ◯ヶ月定期便：月によらず商品配送順指定

#### **4.3 データクレンジング処理**

##### **4.3.1 数字処理**
- **寄附金額1**: テキストから数値部分を抽出
- **提供価格(税込)1**: テキストから数値部分を抽出
- **固定送料1**: テキストから数値部分を抽出

##### **4.3.2 発送種別変換**
- 常温 → 通常便
- 冷蔵 → 冷蔵便
- 冷凍 → 冷凍便

##### **4.3.3 日付フォーマット統一**
- yyyy年mm月dd日 → yyyy/mm/dd
- yyyy-mm-dd → yyyy/mm/dd
- GMT形式 → yyyy/mm/dd
- 上旬/下旬 → 具体的日付に変換
  - 上旬: 15日（例：2025年6月上旬 → 2025/06/15）
  - 下旬: 末日（例：2025年6月下旬 → 2025/06/30）

##### **4.3.4 通年扱い処理**
- **キーワード**: 「通年」「順次」「随時」→「通年扱い」
- **期間変換**: 片方が通年扱いの場合、今日の日付に変換

##### **4.3.5 固定値設定**
- **寄附金額(終了)1**: "2099/12/31"
- **在庫数**: 99999
- **アラート在庫数**: 1
- **出荷可能日フラグ**: 月〜日・祝日すべて"有"

##### **4.3.6 期間別処理**
- **受付期間種別**:
  - 開始が「通年扱い」→ "通年扱い"、開始・終了を空欄
  - 開始が具体日付→ "季節限定扱い"、期間はそのまま保持
- **発送期間**: 受付期間と同様の処理

##### **4.3.7 文字変換処理**
- **配送伝票商品名称**: 全角カッコ（）→半角()
- **配達会社用商品コード**: 商品コードと同じ値をコピー

### Phase 5: データクリア（次期実装予定）
- [ ] 一時データのクリーンアップ
- [ ] ログファイルの整理
- [ ] メモリ使用量の最適化

## 7. 動作例

### 7.1 正常動作ログ
```
=== 返礼品情報整形処理開始（Phase 1: 基本データ抽出） ===
✅ ファイルパス読み込み完了
📁 対象ファイル: G:\共有ドライブ\...
✅ パス変換完了: フォルダキー=h_40348_福岡県_久山町_01
✅ 自治体フォルダ検索完了: h_40348_福岡県_久山町_01 (ID: 0AK3Zcc4ekrltUk9PVA)
✅ ファイル取得完了: 2025-06-16_返礼品登録シート_...
✅ Google Sheetsに変換完了: 1qznYNd29fMvzxOBXfalzq16wvmz1CYaZhyPYf52CMJo
✅ 商品名列特定完了: C列 (12行目)
📊 発見した列（C列）とその右隣列（D列）からデータを抽出します
📊 データ抽出範囲: C4:D95 (全92行)
✅ 空行が5行連続: 行85で抽出終了
📊 実際の抽出範囲: C4:D85 (全82行)
📝 抽出データ: 82行のデータを取得

🔍 指定列データ抽出開始: F,H,J,L,N,P
列指定解析: F → 6列目
列指定解析: H → 8列目
列指定解析: J → 10列目
列指定解析: L → 12列目
列指定解析: N → 14列目
列指定解析: P → 16列目
📊 指定列データ抽出完了:
  - ヘッダーデータ: 3行
  - ボディデータ: 92行
📝 列データを情報抽出タブに出力開始
📝 ヘッダーデータ出力: 4行目以降 (D列から、セル結合対応版)
📝 ボディデータ出力: 8行目以降 (D列から、項目名セル結合対応版)
✅ 列データ出力完了
=== 処理完了 ===
```

## 8. 注意事項

- 結合セルの処理は処理時間に影響する可能性がある
- 大量のデータを処理する場合はパフォーマンスを考慮
- 列指定の形式は厳密にチェックする必要がある
- 出力先の既存データは上書きされる
- セル結合による行数調整は項目名部分のみ適用
- 返礼品データは行をずらさずに出力される
