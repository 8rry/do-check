# 開発方針ガイドライン

## 概要
このドキュメントは、返礼品情報整形処理システムの開発における基本方針と実装手順を定義します。

## 基本原則

### 1. Phaseごとの独立性
- **各Phaseは独立して動作する**
- Phase内での修正は他Phaseに影響しない
- 各Phaseは単体でテスト可能である

### 2. 段階的な開発
- **小さな修正から段階的に実装**
- 一度に大きな変更を行わない
- 各段階での動作確認を必ず実施

### 3. 動作確認の徹底
- **各段階での動作確認を必ず実施**
- 問題があれば即座に修正
- 修正後の動作確認を再度実施

### 4. 影響範囲の最小化
- **修正の影響範囲をPhase内に限定**
- 他Phaseへの影響を事前に評価
- 必要に応じて段階的な実装を検討

### 5. リスクゼロでの最適化
- **既存機能に影響を与えない最適化**
- 処理効率とメモリ効率の向上
- コードの可読性と保守性の向上

## 開発フロー

### Step 1: Phase内での実装
```
1. 修正対象のPhaseファイル内で機能を実装
2. そのPhase内での動作を完璧に確認
3. 他のPhaseへの影響を考慮する必要がない
4. 問題があれば即座に修正可能
```

### Step 2: Utilsへの移動
```
1. Phase内で完璧に動作することを確認
2. 共通化が必要な部分のみをUtilsに移動
3. 移動後の動作確認を実施
4. 他Phaseへの影響を段階的に確認
```

### Step 3: 最適化とリファクタリング
```
1. 既存機能の動作を維持しながら最適化
2. ログ出力の改善とログ量の調整
3. コードの可読性と保守性の向上
4. パフォーマンス設定の最適化
```

## 具体的な実装手順

### 新機能追加時の手順
```
1. 対象Phaseを特定
2. Phase内での実装と動作確認
3. 完璧な動作確認後のUtils化検討
4. 段階的な品質向上
```

### バグ修正時の手順
```
1. 問題の切り分け（Phase内での問題か確認）
2. Phase内での修正と動作確認
3. 修正後の動作確認を徹底
4. 他Phaseへの影響がないことを確認
```

### パフォーマンス改善時の手順
```
1. 対象Phaseの現在のパフォーマンスを測定
2. Phase内での改善と動作確認
3. 改善効果の測定
4. 他Phaseへの影響がないことを確認
```

### 最適化とリファクタリングの手順
```
1. 既存機能の動作確認
2. リスクゼロでの最適化実施
3. ログ出力の改善と調整
4. コードの可読性向上
5. 最適化後の動作確認
```

## 品質基準

### コード品質
- **可読性**: 明確で理解しやすいコード
- **保守性**: 修正や拡張が容易なコード
- **テスト性**: 単体テストが可能なコード
- **ドキュメント**: 適切なコメントと説明

### 動作品質
- **正確性**: 期待通りの動作をする
- **安定性**: エラーが発生しない
- **パフォーマンス**: 適切な処理速度
- **エラーハンドリング**: 適切なエラー処理

### ログ品質
- **分かりやすさ**: 初見の人にも理解しやすい
- **適切な量**: 必要な情報のみを出力
- **一貫性**: 統一されたログ出力スタイル
- **デバッグ効率**: 問題の特定が容易

## 実装例

### 取り消し線除外処理の実装例

#### Phase 2内での実装
```
1. Phase2.gs内に関数を実装
2. Phase2の処理で動作確認
3. 取り消し線除外が正しく動作することを確認
4. データの重複や不整合がないことを確認
```

#### 動作確認後のUtils化
```
1. Phase2で完璧に動作することを確認
2. 共通化が必要な部分を特定
3. Utils.gsに移動
4. 移動後の動作確認
5. 他Phaseでの使用を検討
```

### 最適化とリファクタリングの実装例

#### ログ名の改善
```
1. 「最適化」「高速化」などの技術用語を削除
2. 「処理」「設定」など分かりやすい名前に変更
3. 初見の人にも理解しやすいログ出力に変更
4. 統一されたログ出力スタイルの確立
```

#### ログ量の調整
```
1. 詳細ログの削減（ログ量の最適化）
2. 重要な情報のみを出力
3. 必要に応じて詳細ログを有効化可能
4. 処理速度への影響を最小化
```

#### パフォーマンス設定の最適化
```
1. バッチサイズの最適化（100→200）
2. チャンクサイズの最適化（50→100）
3. キャッシュTTLの延長（5分→10分）
4. ログレベルの最適化（本番環境では詳細ログを無効化）
```

## 最新の実装内容（2024年12月）

### 実施された最適化

#### 1. ログ名の改善
- **Code.gs**: 「最適化処理」→「処理」、「並列実行」→「処理」
- **Phase1.gs**: 「超高速版」→「基本版」、「最適化版」→「基本版」
- **Utils.gs**: 「最適化設定」→「設定」

#### 2. ログ量の調整
- **詳細ログの削減**: キャッシュクリア、タイマー警告、パフォーマンス測定
- **重要なログの維持**: 処理開始・完了、エラー情報、処理結果
- **設定の柔軟性**: 必要に応じて詳細ログを有効化可能

#### 3. パフォーマンス設定の最適化
- **バッチサイズ**: 100→200（処理効率向上）
- **チャンクサイズ**: 50→100（メモリ効率向上）
- **キャッシュTTL**: 5分→10分（キャッシュ効率向上）
- **ログレベル**: 本番環境では詳細ログを無効化

#### 4. 関数名の修正
- **結合セル処理**: `processMergedCells` → `processMergedCellsOptimized`
- **情報抽出タブ出力**: `outputProductDataToInfoExtractionTab` → `outputProductDataToInfoExtractionTabOptimized`

### 最適化の効果

#### 処理効率の向上
- **バッチ処理**: より大きな単位での処理により、API呼び出し回数を削減
- **キャッシュ効率**: より長いTTLにより、重複処理を大幅削減
- **ログ出力**: 本番環境では詳細ログを無効化し、処理速度を向上

#### メモリ効率の向上
- **チャンク処理**: より大きなチャンクで処理することで、メモリ割り当てを最適化
- **不要な処理削除**: 並列処理の複雑性を削除し、メモリ使用量を削減

#### 保守性の向上
- **コードの簡潔化**: 複雑な並列処理を削除し、理解しやすいコードに
- **エラーハンドリング**: 統一されたエラー処理により、デバッグが容易に
- **ログの可読性**: 初見の人にも分かりやすいログ出力

## トラブルシューティング

### よくある問題と対処法

#### 1. 他Phaseへの影響
```
問題: 修正が他Phaseに影響を与える
対処法: 
- 修正をPhase内に限定
- 段階的な実装とテスト
- 問題発生時は即座にロールバック
```

#### 2. 動作確認の不備
```
問題: 修正後の動作確認が不十分
対処法:
- 各段階での動作確認を徹底
- 問題があれば即座に修正
- 修正後の動作確認を再度実施
```

#### 3. 共通化のタイミング
```
問題: Utils化のタイミングが適切でない
対処法:
- Phase内で完璧に動作することを確認
- 共通化の必要性を慎重に判断
- 移動後の動作確認を必ず実施
```

#### 4. 関数名の不一致
```
問題: 関数名が変更されたことで存在しない関数を呼び出そうとする
対処法:
- 関数名の変更履歴を追跡
- 呼び出し箇所を一括で修正
- 修正後の動作確認を実施
```

#### 5. ログ出力の問題
```
問題: ログが大量に出力される、または分かりにくい
対処法:
- ログレベルを適切に設定
- 分かりやすいログ名に変更
- 必要な情報のみを出力
```

## 開発環境

### 必要な環境
- Google Apps Scriptエディタ
- テスト用のスプレッドシート
- サンプルデータ

### 推奨ツール
- コードエディタ（VSCode等）
- Git（バージョン管理）
- ログ解析ツール

## レビュープロセス

### コードレビューのポイント
1. **Phase内での完結性**: 修正がPhase内で完結しているか
2. **動作確認の徹底性**: 適切な動作確認が実施されているか
3. **品質基準の遵守**: コード品質と動作品質が満たされているか
4. **影響範囲の最小化**: 他Phaseへの影響が最小限に抑えられているか
5. **ログ出力の適切性**: ログが分かりやすく、適切な量で出力されているか

### レビュー後の対応
1. **指摘事項の修正**: レビューで指摘された事項を修正
2. **修正後の動作確認**: 修正後の動作確認を実施
3. **再レビュー**: 必要に応じて再レビューを実施

## まとめ

### 重要なポイント
1. **Phaseごとの独立性を保つ**
2. **段階的な開発を徹底する**
3. **動作確認を必ず実施する**
4. **影響範囲を最小限に抑える**
5. **リスクゼロでの最適化を実施する**
6. **ログの可読性と適切な量を維持する**

### 期待される効果
- **開発効率の向上**: 問題の切り分けが容易
- **品質の向上**: 段階的な品質向上が可能
- **保守性の向上**: 修正の影響範囲が明確
- **チーム開発の効率化**: 統一された開発方針
- **処理効率の向上**: 最適化による処理速度の向上
- **メモリ効率の向上**: 最適化によるメモリ使用量の削減
- **ログの可読性向上**: 初見の人にも理解しやすいログ出力

この方針を徹底することで、高品質で保守性の高いシステムを開発できます。
