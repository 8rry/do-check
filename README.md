# 返礼品情報整形処理システム

## 概要
Google Drive上のExcelファイルから返礼品情報を抽出し、Google Sheetsの「情報抽出」タブに整形して出力するシステムです。

## 機能
- **Phase 1**: 基本データ抽出（商品名、商品コード等）
- **Phase 2**: 指定列データ抽出（B2セル指定またはF列起点）
- **Phase 3**: Do書き出し項目との紐付け
- **Phase 4**: Doへの書き出し（高速化対応）
  - 列インデックスキャッシュ（50-70%高速化）
  - 外部シート参照最適化（20-30%高速化）
  - データ変換処理最適化（10-20%高速化）
- **Phase 5**: データクリア（情報抽出タブ、Do書き出し用タブ、Do書き出し用(定期)タブの一括クリア）

## 一時ファイル管理システム
処理が途中で止まった場合の残存ファイルを自動的にクリーンアップする包括的なシステムです。

### 主要機能
- **自動登録・管理**: 一時ファイルIDを自動的に追跡
- **包括的クリーンアップ**: 登録済みファイル、パターンマッチ、古いファイルを一括削除
- **エラー時自動クリーンアップ**: 処理エラー発生時に強制クリーンアップ
- **定期クリーンアップ**: 6時間間隔での自動メンテナンス
- **手動クリーンアップ**: 必要に応じて手動実行可能

### クリーンアップ対象
- 登録済み一時ファイル（即座に削除）
- `temp_*`パターンのファイル（12時間以上前）
- 古い一時ファイル（6時間以上前）
- 強制クリーンアップ時は全対象ファイルを即座に削除

### 手動実行関数
- `manualTempFileCleanup()`: 強制クリーンアップ（残存ファイルの即座削除）
- `manualScheduledTempFileCleanup()`: 定期クリーンアップ（メンテナンス用）
- `showTempFileManagementStatus()`: 管理状況の表示

## 開発方針

### 基本原則
1. **Phaseごとの独立性**: 各Phaseは独立して動作する
2. **段階的な開発**: 小さな修正から段階的に実装
3. **動作確認の徹底**: 各段階での動作確認を必ず実施
4. **影響範囲の最小化**: 修正の影響範囲をPhase内に限定

### 開発フロー
1. Phase内での実装と動作確認
2. 完璧な動作確認後のUtils化検討
3. 段階的な品質向上
4. 他Phaseへの影響の段階的確認

### 品質基準
- 各Phaseは独立して完璧に動作する
- 修正はPhase内で完結する
- 問題発生時は即座にロールバック
- 段階的な実装とテストを徹底

## ファイル構成
```
gas/
├── Code.gs          # メイン制御（一時ファイル管理統合）
├── Phase1.gs        # 基本データ抽出（一時ファイル登録対応）
├── Phase2.gs        # 指定列データ抽出
├── Phase3.gs        # Do項目紐付け
├── Phase4.gs        # Doへの書き出し
├── Phase5.gs        # データクリア（各タブの内容を一括クリア）
├── Config.gs        # 設定管理
└── Utils.gs         # 共通機能（包括的一時ファイル管理システム）
```

## 使用方法

### 基本処理（Phase 1-4）
1. Google Apps Scriptエディタでプロジェクトを開く
2. `main()`関数を実行
3. ファイルパスを入力（B1セル）
4. 抽出する列を指定（B2セル、空の場合はF列起点）
5. 処理完了後、情報抽出タブで結果を確認
6. 一時ファイルは自動的にクリーンアップされる

### データクリア（Phase 5）
1. `executePhase5Standalone()`関数を実行
2. 情報抽出タブ、Do書き出し用タブ、Do書き出し用(定期)タブの内容が一括でクリアされる
3. 項目名（1行目）は保持される

### 一時ファイル管理
1. **自動クリーンアップ**: 処理完了時に自動実行
2. **手動クリーンアップ**: `manualTempFileCleanup()`で残存ファイルを即座削除
3. **定期メンテナンス**: `manualScheduledTempFileCleanup()`で定期的にクリーンアップ
4. **状況確認**: `showTempFileManagementStatus()`で管理状況を確認

## 設定
- スプレッドシートID: `Config.gs`で設定
- シート名: 情報抽出、Do書き出し用等
- パフォーマンス設定: チャンクサイズ、キャッシュTTL等
- 一時ファイル管理: クリーンアップ間隔、削除対象パターン等

## 注意事項
- 大きなExcelファイルは処理時間がかかる場合があります
- 結合セルがある場合は適切に処理されます
- 一時ファイルは自動的に削除されます
- 処理が途中で止まった場合は`manualTempFileCleanup()`で手動クリーンアップ可能
- 一時ファイル管理状況は`showTempFileManagementStatus()`で確認可能
