# 返礼品情報整形GASプロジェクト

## 📋 概要
事業者から集めた返礼品情報を、マスタ登録用に整形するGoogle Apps Script（GAS）プロジェクト

## 🚀 主要機能
- **Phase 1**: 基本データ抽出
  - 返礼品シートから商品名を含む列を自動特定
  - A列〜D列で「商品名」を検索
  - 発見した列と右隣列のデータを抽出、セル結合処理
  - 結合セル内の空行追加（右列データ状況を考慮）
  
- **Phase 2**: 指定列データ抽出
  - B2セルで指定列の選択的抽出
  - F列起点の返礼品データ抽出
  - **結合セル対応**: 行・列方向の結合セル内の情報統合
  - **有効列判定**: 実際にデータが入っている列のみを処理対象
  - **重複データ排除**: 結合セル内の重複データを防止

- **Phase 3**: Do書き出し項目との紐付け
  - 情報抽出タブのB列・C列の値をみながら、A列の項目を設定する

- **Phase 4**: データクレンジング
  - 情報抽出タブのD8以降のデータをルールに基づきクレンジングする

- **Phase 5**: Doへの書き出し
  - 単品登録と定期便登録の判別
  - 単品登録は、Do書き出し用タブへ書き込み
  - 定期便登録は、定期便処理を実行し、Do書き出し用(定期)タブへ書き込み

- **Phase 6**: データクリア
  - 処理情報をクリアする

## 📁 ファイル構成
```
do-check/
├── gas/                    # Google Apps Scriptファイル群
│   ├── Code.gs            # メイン制御（制御系のみ）
│   ├── Phase1.gs          # 基本データ抽出処理
│   ├── Phase2.gs          # 指定列データ抽出処理
│   ├── Config.gs          # 設定定数
│   └── Utils.gs           # ユーティリティ関数（パス処理、共通処理）
├── README.md               # このファイル（プロジェクト概要）
├── SPECIFICATION.md        # 詳細仕様書
└── IMPLEMENTATION.md       # 実装詳細
```

## 🎯 対象データ
- 返礼品シート（Excelファイル .xlsx）
- 自治体フォルダ内の事業者フォルダ
- 指定されたセル範囲のデータ

## 🔧 技術仕様
- **言語**: Google Apps Script (GAS)
- **対象**: Excelファイル (.xlsx)
- **出力**: スプレッドシート形式
- **対応**: セル結合、動的列位置、結合セル内の情報統合
- **処理最適化**: 有効列のみの処理、重複データ排除
- **パフォーマンス**: バッチ処理、結合セル情報のキャッシュ

## 📊 スプレッドシート構成
- **ベーススプレッドシート**: [返礼品情報整形用スプレッドシート](https://docs.google.com/spreadsheets/d/1W-Kmre4FTL5iU0VNSs5Z4vLVsXzFebLYlxSxnPWkxPQ/edit?gid=0#gid=0)

### タブ構成
1. **情報抽出** - 返礼品シートからのデータ抽出設定
2. **Do書き出し用** - 通常便用のデータ出力
3. **Do書き出し用(定期)** - 定期便用のデータ出力
4. **自治体フォルダ** - 自治体フォルダの管理

## 🚀 使用方法

### 1. 基本設定
1. **情報抽出タブのB1セル**に返礼品シートのファイルパスを設定
2. **自治体フォルダタブ**に自治体フォルダ情報を設定

### 2. 実行手順
1. GASプロジェクトで `main()` 関数を実行
2. 自動的にPhase 1とPhase 2の処理が実行される

### 3. 実行確認
- **Phase 1**: 基本データ抽出の実行確認
- **Phase 2**: 指定列データ抽出の実行確認
- **Utils**: ユーティリティ関数の動作確認

### 4. 出力結果
- **B8:C** - Phase 1の基本データ（商品名列と右隣列）
- **D4以降** - Phase 2の指定列データ（1列1返礼品形式）

### 5. 結合セル処理例
```
入力データ:
F列: '賞味期限の場合はこちらに記入→'
G列: '300日'

出力結果:
F列: '賞味期限の場合はこちらに記入 → 300日'  ← 統合値
G列: ''  ← 空値（重複排除）
```

### 6. 有効列判定例
```
理論上の最終列: 37列目
実際の有効列: 18列目
処理対象: 6列目〜18列目（13列）
→ 19列目以降は空列連続のため処理終了
```

## 🆕 新機能詳細

### 結合セル対応機能
- **情報統合**: 結合セル内の分割された情報を適切に統合
- **矢印処理**: `'賞味期限の場合はこちらに記入→' + '300日'` → `'賞味期限の場合はこちらに記入 → 300日'`
- **重複排除**: 結合セルの開始列のみに値を設定、他の列は空値

### 有効列判定機能
- **自動判定**: 実際にデータが入っている列のみを処理対象
- **空列連続検出**: 3列連続で空の列があれば処理終了
- **処理効率化**: 無駄な空列の処理を排除

### パフォーマンス最適化
- **バッチ処理**: `setValues`による一括データ出力
- **結合セルキャッシュ**: 結合セル情報の効率的な処理
- **ログ最適化**: 詳細な処理状況の可視化

## 📈 開発状況
- [x] **Phase 1**: 基本データ抽出（完了）
- [x] **Phase 2**: 指定列データ抽出（完了・結合セル対応済み）
- [ ] **Phase 3**: Do書き出し用タブへの出力（予定）

## 🔍 詳細情報
- **仕様詳細**: [SPECIFICATION.md](./SPECIFICATION.md)
- **実装詳細**: [IMPLEMENTATION.md](./IMPLEMENTATION.md)

## 📝 注意事項
- Google Apps Scriptの実行時間制限（6分）に注意
- 大量データ処理時は分割実行を検討
- 実行前にテスト実行で動作確認を推奨
